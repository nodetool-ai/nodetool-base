name: Python Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Download packaged Conda environment
        run: |
          set -e
          TAG=$(curl -sL https://api.github.com/repos/nodetool-ai/nodetool/releases/latest | grep -m1 '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          FILENAME=conda-env-linux-x64.tar.gz
          URL="https://github.com/nodetool-ai/nodetool/releases/download/${TAG}/${FILENAME}"
          echo "Downloading Conda env from ${URL}"
          curl -L -o conda_env.tgz "$URL"
          mkdir -p conda_env
          tar -xzf conda_env.tgz -C conda_env
          echo "CONDA_ENV_BIN=$(pwd)/conda_env/bin" >> $GITHUB_ENV

      - name: Add Conda env to PATH
        run: echo "$CONDA_ENV_BIN" >> $GITHUB_PATH

      - name: Verify Python from packaged env
        run: |
          which python
          python -V
          uv pip -V

      - name: Install project and dev requirements
        run: |
          uv pip install -e . --system
          if [ -f requirements-dev.txt ]; then uv pip install -r requirements-dev.txt --system; fi

      - name: Run tests
        run: pytest
