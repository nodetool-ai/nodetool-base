# Auto-Save Asset Feature

## Overview

This document describes the auto-save feature for nodes that generate assets (images, audio, video, etc.).

## What is Auto-Save?

When a node has `_auto_save_asset = True`, any AssetRef (ImageRef, AudioRef, VideoRef, etc.) in the node's output will be automatically saved to storage with tracking information including:

- `node_id` - The ID of the node that generated the asset
- `job_id` - The ID of the job/workflow run
- `workflow_id` - The ID of the workflow

## Implementation

### Adding Auto-Save to a Node

To enable auto-save for a node, add the class variable `_auto_save_asset` with value `True`:

```python
from typing import ClassVar
from nodetool.workflows.base_node import BaseNode
from nodetool.metadata.types import ImageRef

class MyImageNode(BaseNode):
    """
    Example node that generates images.
    """
    
    _auto_save_asset: ClassVar[bool] = True  # Enable auto-save
    
    async def process(self, context: ProcessingContext) -> ImageRef:
        # Generate your image
        image = await context.image_from_bytes(image_data)
        return image  # Will be automatically saved!
```

### Which Nodes Have Auto-Save Enabled?

Auto-save is enabled for all nodes that:
1. **Generate** or **transform** assets (create new ImageRef, AudioRef, VideoRef, etc.)
2. Are **not** Load* or Save* nodes (these handle their own storage logic)

This includes:

#### Core Nodes (47 nodes)
- **Image nodes**: TextToImage, ImageToImage, Paste, Scale, Resize, Crop, Fit
- **Audio nodes**: Normalize, OverlayAudio, RemoveSilence, TextToSpeech, CreateSilence, Concat, etc.
- **Video nodes**: TextToVideo, ImageToVideo, Trim, Overlay, ColorBalance, AddSubtitles, etc.

#### AI Provider Nodes (45 nodes)
- **OpenAI**: CreateImage, TextToSpeech
- **Gemini**: ImageGeneration, TextToSpeech, TextToVideo, ImageToVideo
- **KIE**: 39 nodes across image, audio, and video generation

#### Library Nodes (41 nodes)
- **Pillow**: All image enhancement, filtering, and color grading nodes (37 nodes)
- **Other libraries**: CombineImageGrid, SVGToImage, ChartRenderer, PlotArray

**Total: 133 nodes have auto-save enabled**

## Benefits

1. **Automatic Tracking**: Assets are automatically tagged with node_id, job_id, and workflow_id
2. **Simplified Code**: No need to manually call `context.create_asset()` 
3. **Consistent Behavior**: All asset-generating nodes behave the same way
4. **Better Debugging**: Easy to trace which node created which asset

## Example Usage

### Before (Manual Save)
```python
class MyImageNode(BaseNode):
    async def process(self, context: ProcessingContext) -> ImageRef:
        image_data = generate_image()
        image = await context.image_from_bytes(image_data)
        
        # Manual save with tracking
        saved_image = await context.create_asset(
            asset_ref=image,
            node_id=self.id,
            job_id=context.job_id,
            workflow_id=context.workflow_id
        )
        return saved_image
```

### After (Auto-Save)
```python
class MyImageNode(BaseNode):
    _auto_save_asset: ClassVar[bool] = True  # Enable auto-save
    
    async def process(self, context: ProcessingContext) -> ImageRef:
        image_data = generate_image()
        image = await context.image_from_bytes(image_data)
        return image  # Automatically saved with tracking!
```

## Querying Assets

With auto-save enabled, you can easily query assets by:

```python
# Get all assets generated by a specific node
assets_by_node = await context.get_assets_by_node(node_id)

# Get all assets from a specific job
assets_by_job = await context.get_assets_by_job(job_id)

# Get all assets from a workflow
assets_by_workflow = await context.get_assets_by_workflow(workflow_id)
```

## Testing

Tests are provided in `tests/nodetool/test_auto_save_asset.py` to verify:

1. All asset-generating nodes have `_auto_save_asset = True`
2. Load* and Save* nodes are excluded
3. Core, provider, and library nodes are properly configured

Run tests with:
```bash
pytest tests/nodetool/test_auto_save_asset.py -v
```

## Notes

- The actual auto-save infrastructure is implemented in `nodetool-core` (the base framework)
- This repository (`nodetool-base`) contains the node implementations with the feature enabled
- Nodes that only load or save assets (Load*, Save*) do NOT have auto-save enabled as they manage storage themselves
