# Auto-Save Asset Feature

## Overview

This document describes the auto-save feature for nodes that **generate** assets (images, audio, video, etc.) from scratch.

## What is Auto-Save?

When a node has `_auto_save_asset = True`, any AssetRef (ImageRef, AudioRef, VideoRef, etc.) in the node's output will be automatically saved to storage with tracking information including:

- `node_id` - The ID of the node that generated the asset
- `job_id` - The ID of the job/workflow run
- `workflow_id` - The ID of the workflow

## Important: Generative Nodes Only

**Auto-save is only enabled for generative nodes** - nodes that create content from scratch:

✅ **Enabled for:**
- Text-to-Image (e.g., `TextToImage`, `CreateImage`)
- Text-to-Audio (e.g., `TextToSpeech`, `GenerateMusic`)
- Text-to-Video (e.g., `TextToVideo`)
- Image-to-Image generation (e.g., `ImageToImage`)
- Image-to-Video generation (e.g., `ImageToVideo`)
- Content generation from nothing (e.g., `CreateSilence`)

❌ **NOT enabled for:**
- Editing/transformation nodes (e.g., `Resize`, `Crop`, `Normalize`, `Trim`)
- Library nodes (e.g., Pillow filters, enhancements, color grading)
- Load/Save nodes (e.g., `LoadImage`, `SaveImage`)

## Implementation

### Adding Auto-Save to a Generative Node

To enable auto-save for a generative node, add the class variable `_auto_save_asset` with value `True`:

```python
from typing import ClassVar
from nodetool.workflows.base_node import BaseNode
from nodetool.metadata.types import ImageRef

class TextToImage(BaseNode):
    """
    Generate images from text prompts.
    """
    
    _auto_save_asset: ClassVar[bool] = True  # Enable auto-save
    
    async def process(self, context: ProcessingContext) -> ImageRef:
        # Generate your image
        image = await context.image_from_bytes(image_data)
        return image  # Will be automatically saved!
```

### Which Nodes Have Auto-Save Enabled?

Auto-save is enabled for approximately **50 generative nodes**:

#### Core Generative Nodes (7 nodes)
- **Image**: TextToImage, ImageToImage
- **Audio**: TextToSpeech, CreateSilence
- **Video**: TextToVideo, ImageToVideo, FrameToVideo
- **3D**: TextTo3D, ImageTo3D

#### AI Provider Nodes (6 nodes)
- **OpenAI**: CreateImage, TextToSpeech
- **Gemini**: ImageGeneration, TextToSpeech, TextToVideo, ImageToVideo

#### KIE Generative Nodes (~37 nodes)
- **Image generation**: Flux2Pro, Flux2Flex, Seedream, ZImage, NanoBanana, GrokImagine, Qwen, Imagen4, etc.
- **Audio generation**: GenerateMusic, GenerateMusicVideo, ElevenLabsTextToSpeech
- **Video generation**: All TextToVideo and ImageToVideo variants (Kling, Sora, Hailuo, Runway, Veo, etc.)
- **Avatar generation**: KlingAIAvatar nodes

## Benefits

1. **Automatic Tracking**: Assets are automatically tagged with node_id, job_id, and workflow_id
2. **Simplified Code**: No need to manually call `context.create_asset()` for generative nodes
3. **Consistent Behavior**: All generative nodes behave the same way
4. **Better Debugging**: Easy to trace which node created which asset

## Example Usage

### Generative Node (Auto-Save Enabled)
```python
class TextToImage(BaseNode):
    _auto_save_asset: ClassVar[bool] = True
    
    async def process(self, context: ProcessingContext) -> ImageRef:
        image_data = generate_image()
        return await context.image_from_bytes(image_data)
        # Automatically saved with tracking!
```

### Editing Node (Auto-Save NOT Enabled)
```python
class Resize(BaseNode):
    # No _auto_save_asset - this is an editing node
    
    async def process(self, context: ProcessingContext) -> ImageRef:
        image = await context.image_to_pil(self.image)
        resized = image.resize((self.width, self.height))
        return await context.image_from_pil(resized)
        # Not automatically saved - transforms existing asset
```

## Querying Assets

With auto-save enabled, you can easily query assets by:

```python
# Get all assets generated by a specific node
assets_by_node = await context.get_assets_by_node(node_id)

# Get all assets from a specific job
assets_by_job = await context.get_assets_by_job(job_id)

# Get all assets from a workflow
assets_by_workflow = await context.get_assets_by_workflow(workflow_id)
```

## Testing

Tests are provided in `tests/nodetool/test_auto_save_asset.py` to verify:

1. Generative nodes have `_auto_save_asset = True`
2. Editing/transformation nodes do NOT have `_auto_save_asset = True`
3. Library nodes do NOT have `_auto_save_asset = True`
4. Load*/Save* nodes do NOT have `_auto_save_asset = True`

Run tests with:
```bash
pytest tests/nodetool/test_auto_save_asset.py -v
```

## Notes

- The actual auto-save infrastructure is implemented in `nodetool-core` (the base framework)
- This repository (`nodetool-base`) contains the node implementations with the feature enabled for generative nodes only
- Editing/transformation nodes do NOT have auto-save as they transform existing assets rather than generating new content
