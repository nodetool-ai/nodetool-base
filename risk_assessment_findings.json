{
  "report_metadata": {
    "generated_at": "2025-12-25T11:26:47.772Z",
    "repository": "nodetool-ai/nodetool-base",
    "total_source_files": 190,
    "total_test_functions": 566,
    "overall_risk_level": "MEDIUM-HIGH",
    "release_ready": false
  },
  "summary": {
    "total_findings": 63,
    "critical": 3,
    "high": 3,
    "medium": 4,
    "low": 2,
    "test_status": {
      "passed": 473,
      "failed": 27,
      "errors": 2,
      "skipped": 0
    }
  },
  "release_blocking_issues": [
    {
      "id": "SQL-001",
      "title": "SQL Injection Vulnerabilities in SQLite Module",
      "category": "security",
      "severity": "critical",
      "confidence": "high",
      "effort_to_fix": "medium"
    },
    {
      "id": "TEST-001",
      "title": "Broken Test Files - Missing Module References",
      "category": "broken",
      "severity": "critical",
      "confidence": "high",
      "effort_to_fix": "low"
    },
    {
      "id": "TEST-002",
      "title": "KIE Test Async/Await Failures",
      "category": "broken",
      "severity": "critical",
      "confidence": "high",
      "effort_to_fix": "medium"
    }
  ],
  "findings": [
    {
      "id": "SQL-001",
      "category": "security",
      "severity": "critical",
      "confidence": "high",
      "title": "SQL Injection - Table Name Interpolation",
      "file": "src/nodetool/nodes/lib/sqlite.py",
      "line": 77,
      "code_snippet": "table_exists = conn.execute(f\"SELECT name FROM sqlite_master WHERE type='table' AND name='{self.table_name}'\").fetchone() is not None",
      "problem": "Table name directly interpolated into SQL query without sanitization",
      "risk_explanation": "Attackers can inject arbitrary SQL commands through table_name parameter",
      "suggested_fix": "Use parameterized query: conn.execute('SELECT name FROM sqlite_master WHERE type=? AND name=?', ('table', self.table_name))",
      "references": ["CWE-89", "OWASP SQL Injection"]
    },
    {
      "id": "SQL-002",
      "category": "security",
      "severity": "critical",
      "confidence": "high",
      "title": "SQL Injection - WHERE Clause",
      "file": "src/nodetool/nodes/lib/sqlite.py",
      "line": 229,
      "code_snippet": "sql += f\" WHERE {self.where}\"",
      "problem": "WHERE clause from user input directly interpolated into SQL",
      "risk_explanation": "Complete SQL injection vulnerability - user controls WHERE clause",
      "suggested_fix": "Parse and validate WHERE clause, or use parameterized queries with a query builder"
    },
    {
      "id": "SQL-003",
      "category": "security",
      "severity": "critical",
      "confidence": "high",
      "title": "SQL Injection - UPDATE Statement",
      "file": "src/nodetool/nodes/lib/sqlite.py",
      "line": 300,
      "code_snippet": "sql = f\"UPDATE {self.table_name} SET {set_clause}\"",
      "problem": "Table name and SET clause directly interpolated",
      "risk_explanation": "Allows arbitrary data modification through injection"
    },
    {
      "id": "SQL-004",
      "category": "security",
      "severity": "critical",
      "confidence": "high",
      "title": "SQL Injection - DELETE Statement",
      "file": "src/nodetool/nodes/lib/sqlite.py",
      "line": 359,
      "code_snippet": "sql = f\"DELETE FROM {self.table_name} WHERE {self.where}\"",
      "problem": "Both table name and WHERE clause directly interpolated",
      "risk_explanation": "Allows arbitrary data deletion through injection"
    },
    {
      "id": "TEST-001",
      "category": "broken",
      "severity": "critical",
      "confidence": "high",
      "title": "Missing Module - tar",
      "file": "tests/nodetool/test_os_nodes.py",
      "line": 9,
      "code_snippet": "from nodetool.nodes.lib.tar import (CreateTar, ExtractTar, ListTar)",
      "problem": "Test imports module nodetool.nodes.lib.tar which does not exist",
      "risk_explanation": "Test file cannot be collected, CI will fail",
      "suggested_fix": "Remove test file or implement the missing tar module"
    },
    {
      "id": "TEST-002",
      "category": "broken",
      "severity": "critical",
      "confidence": "high",
      "title": "Missing Module - textwrap",
      "file": "tests/nodetool/test_textwrap.py",
      "line": 3,
      "code_snippet": "from nodetool.nodes.lib.textwrap import Fill, Wrap, Shorten, Indent, Dedent",
      "problem": "Test imports module nodetool.nodes.lib.textwrap which does not exist",
      "risk_explanation": "Test file cannot be collected, CI will fail",
      "suggested_fix": "Remove test file or implement the missing textwrap module"
    },
    {
      "id": "TEST-003",
      "category": "broken",
      "severity": "high",
      "confidence": "high",
      "title": "KIE Tests - Async Not Awaited",
      "file": "tests/nodetool/test_kie_nodes.py",
      "line": null,
      "problem": "25+ tests fail because async methods are not awaited",
      "risk_explanation": "KIE integration is not properly tested",
      "suggested_fix": "Add await to calls to _get_submit_payload and _get_input_params",
      "affected_tests": [
        "TestFlux2ProTextToImage::test_submit_payload",
        "TestFlux2ProTextToImage::test_empty_prompt_raises_error",
        "TestFlux2ProTextToImage::test_model_and_params",
        "TestSeedream45TextToImage::test_model_and_params",
        "TestZImage::test_model_and_params",
        "TestNanoBanana::test_model_and_params",
        "TestFlux2Pro::test_model_and_params"
      ]
    },
    {
      "id": "TEST-004",
      "category": "broken",
      "severity": "high",
      "confidence": "high",
      "title": "Missing Class Definition - Sora2ImageToVideo",
      "file": "tests/nodetool/test_kie_nodes.py",
      "line": null,
      "problem": "Test references Sora2ImageToVideo which is not defined",
      "risk_explanation": "Test will fail with NameError"
    },
    {
      "id": "DEAD-001",
      "category": "tech-debt",
      "severity": "high",
      "confidence": "high",
      "title": "Large Commented-Out Code Block - RealtimeWhisper",
      "file": "src/nodetool/nodes/nodetool/audio.py",
      "line": 965,
      "lines_affected": 225,
      "problem": "~220 lines of commented-out code for RealtimeWhisper class",
      "risk_explanation": "Dead code clutters codebase, may confuse developers about feature status",
      "suggested_fix": "Remove commented code and document in issue tracker if feature is planned"
    },
    {
      "id": "ERR-001",
      "category": "fragile",
      "severity": "medium",
      "confidence": "medium",
      "title": "Silent Exception Handling - Agents Module",
      "file": "src/nodetool/nodes/nodetool/agents.py",
      "lines": [442, 448, 462, 693, 709, 733, 805, 811, 815, 834, 838, 1409],
      "problem": "Multiple instances of 'except Exception: pass' or 'except Exception:' with no logging",
      "risk_explanation": "Errors are silently swallowed, making debugging impossible",
      "suggested_fix": "Add logging at minimum, or propagate specific exceptions"
    },
    {
      "id": "ERR-002",
      "category": "fragile",
      "severity": "medium",
      "confidence": "medium",
      "title": "Silent Exception Handling - OpenAI Agents",
      "file": "src/nodetool/nodes/openai/agents.py",
      "lines": [394, 454, 468, 683, 700, 710],
      "problem": "Silent exception handling in OpenAI integration",
      "risk_explanation": "API errors may be hidden from users"
    },
    {
      "id": "ERR-003",
      "category": "fragile",
      "severity": "medium",
      "confidence": "medium",
      "title": "Silent Exception Handling - Browser Module",
      "file": "src/nodetool/nodes/lib/browser.py",
      "lines": [79, 101, 105, 183, 457],
      "problem": "Browser errors silently ignored",
      "risk_explanation": "Browser automation failures may go unnoticed"
    },
    {
      "id": "ASSERT-001",
      "category": "fragile",
      "severity": "medium",
      "confidence": "medium",
      "title": "Assert Statements in Production Code",
      "affected_files": [
        {
          "file": "src/nodetool/nodes/lib/excel.py",
          "lines": [61, 92, 135, 180, 240, 268]
        },
        {
          "file": "src/nodetool/nodes/lib/docx.py",
          "lines": [82, 107, 145, 177, 196, 218, 263, 264]
        },
        {
          "file": "src/nodetool/nodes/vector/chroma.py",
          "lines": [35, 142, 160, 431, 432, 433, 434, 484, 485, 486, 487, 719, 720, 721, 722]
        },
        {
          "file": "src/nodetool/nodes/gemini/image.py",
          "lines": [60, 106, 117, 119, 120]
        },
        {
          "file": "src/nodetool/nodes/gemini/video.py",
          "lines": [81, 91, 92, 93, 94, 152, 181, 182, 183, 184]
        },
        {
          "file": "src/nodetool/nodes/gemini/audio.py",
          "lines": [118, 150, 151, 152]
        }
      ],
      "total_instances": 55,
      "problem": "Assert statements used for input validation and error handling",
      "risk_explanation": "Asserts can be disabled with python -O flag, causing silent failures",
      "suggested_fix": "Replace with proper if/raise patterns or validation decorators"
    },
    {
      "id": "INCOMPLETE-001",
      "category": "incomplete",
      "severity": "medium",
      "confidence": "high",
      "title": "NotImplementedError Without Message",
      "file": "src/nodetool/nodes/lib/numpy/utils.py",
      "line": 52,
      "code_snippet": "raise NotImplementedError()",
      "problem": "NotImplementedError raised without explanation message",
      "suggested_fix": "raise NotImplementedError('Subclasses must implement operation() method')"
    },
    {
      "id": "COVERAGE-001",
      "category": "test-gap",
      "severity": "medium",
      "confidence": "medium",
      "title": "Missing Test Coverage for Multiple Modules",
      "untested_modules": [
        "audio", "browser", "chroma", "code", "color_grading", "control",
        "data", "discord", "document", "docx", "draw", "enhance",
        "excel", "faiss", "filter", "google", "io", "manipulation",
        "markdown", "markitdown", "ocr", "output", "pandoc",
        "pdfplumber", "pymupdf", "reshaping", "seaborn", "svg",
        "arithmetic", "conversion", "statistics"
      ],
      "problem": "40+ node modules have no corresponding test files",
      "risk_explanation": "High regression risk, bugs may go undetected"
    },
    {
      "id": "SEC-002",
      "category": "security",
      "severity": "low",
      "confidence": "medium",
      "title": "Subprocess Without Input Validation",
      "file": "src/nodetool/nodes/lib/os.py",
      "line": 34,
      "code_snippet": "subprocess.run(['open', context.workspace_dir])",
      "problem": "workspace_dir passed to subprocess without validation",
      "risk_explanation": "If workspace_dir is user-controllable, potential command injection",
      "suggested_fix": "Validate workspace_dir format and use absolute path resolution"
    },
    {
      "id": "DEBT-002",
      "category": "tech-debt",
      "severity": "low",
      "confidence": "low",
      "title": "Temporary Files with delete=False",
      "file": "src/nodetool/nodes/nodetool/video.py",
      "lines": [689, 690, 691, 692, 776, 777, 861, 862],
      "problem": "tempfile.NamedTemporaryFile(delete=False) used extensively with manual cleanup",
      "risk_explanation": "Temp files may not be cleaned up if exceptions occur"
    }
  ],
  "remediation_priority": [
    {
      "phase": "immediate",
      "description": "Before Release",
      "items": [
        "SQL-001 through SQL-004: Fix SQL injection vulnerabilities",
        "TEST-001, TEST-002: Remove or fix broken test files",
        "TEST-003, TEST-004: Fix KIE test async/await issues"
      ]
    },
    {
      "phase": "short_term",
      "description": "Next Sprint",
      "items": [
        "ERR-001 through ERR-003: Add logging to silent exception handlers",
        "ASSERT-001: Replace assert statements with proper validation",
        "DEAD-001: Remove commented-out RealtimeWhisper code"
      ]
    },
    {
      "phase": "medium_term",
      "description": "Technical Debt Reduction",
      "items": [
        "COVERAGE-001: Improve test coverage for untested modules",
        "SEC-002: Add input validation to user-facing inputs",
        "Standardize error handling patterns across codebase"
      ]
    }
  ],
  "quick_wins": [
    {
      "fix": "Remove broken test imports",
      "files": ["tests/nodetool/test_os_nodes.py", "tests/nodetool/test_textwrap.py"],
      "effort": "< 30 minutes",
      "impact": "CI passes"
    },
    {
      "fix": "Add await to KIE tests",
      "files": ["tests/nodetool/test_kie_nodes.py"],
      "effort": "< 1 hour",
      "impact": "Tests validate correctly"
    },
    {
      "fix": "Add identifier validation to SQLite",
      "files": ["src/nodetool/nodes/lib/sqlite.py"],
      "effort": "< 1 hour",
      "impact": "Prevents basic SQL injection"
    },
    {
      "fix": "Remove commented RealtimeWhisper",
      "files": ["src/nodetool/nodes/nodetool/audio.py"],
      "effort": "< 30 minutes",
      "impact": "Cleaner codebase"
    }
  ],
  "deeper_refactors": [
    {
      "refactor": "Comprehensive SQL query builder",
      "scope": "sqlite.py + potentially other DB modules",
      "effort": "2-3 days",
      "benefit": "Full SQL injection protection"
    },
    {
      "refactor": "Test coverage expansion",
      "scope": "40+ untested modules",
      "effort": "1-2 weeks",
      "benefit": "Regression safety"
    },
    {
      "refactor": "Error handling standardization",
      "scope": "Codebase-wide",
      "effort": "1 week",
      "benefit": "Debuggability, reliability"
    },
    {
      "refactor": "Assert replacement",
      "scope": "55+ locations",
      "effort": "2-3 days",
      "benefit": "Runtime safety"
    }
  ]
}
